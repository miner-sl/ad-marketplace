# Регистрация каналов через Telegram бота

## Как получить список каналов, где бот является админом

В Telegram Bot API **нет прямого метода** для получения списка всех каналов, где бот является администратором. Однако есть несколько подходов:

### Подход 1: Команда из канала (Рекомендуется)

Самый простой способ - вызвать команду бота **прямо из канала**:

1. **Добавьте бота как администратора** в ваш канал
2. **Дайте боту права на публикацию сообщений**
3. **Отправьте команду `/register_channel` из канала**

Бот автоматически:
- Определит ID канала из контекста
- Проверит, что он является админом
- Проверит, что вы являетесь админом канала
- Зарегистрирует канал в системе
- Сохранит список всех админов как PR менеджеров
- Обновит статистику канала

### Подход 2: Через API

Если вы знаете `telegram_channel_id` канала:

```bash
POST /api/channels
{
  "telegram_id": 123456789,
  "telegram_channel_id": -1001234567890,
  "bot_token": "your_bot_token"
}
```

API автоматически проверит, что бот является админом.

## Команды бота для работы с каналами

### `/register_channel`

Регистрирует канал в системе. **Должна быть вызвана из канала.**

**Требования:**
- Бот должен быть администратором канала
- Вы должны быть администратором канала
- Бот должен иметь права на публикацию сообщений

**Пример использования:**
1. Откройте ваш канал в Telegram
2. Отправьте сообщение: `/register_channel`
3. Бот зарегистрирует канал и покажет информацию

### `/mychannels`

Показывает все ваши зарегистрированные каналы:
- Каналы, где вы владелец
- Каналы, где вы менеджер (PR manager)

### `/verify_admins [channel_id]`

Проверяет и обновляет список администраторов канала.

**Использование:**
- Из канала: `/verify_admins` (автоматически использует текущий канал)
- Из личных сообщений: `/verify_admins <channel_id>`

**Что делает:**
- Получает текущий список админов из Telegram
- Обновляет список менеджеров в базе данных
- Показывает права каждого админа

## Проверка прав перед важными операциями

Система автоматически проверяет права пользователя перед важными операциями:

### Финансовые операции:
- ✅ Принятие сделки (`acceptDeal`)
- ✅ Отправка креатива (`submitCreative`)
- ✅ Подтверждение оплаты

### Проверка включает:
1. **Владелец канала?** - Проверка по `owner_id`
2. **Активный менеджер?** - Проверка в таблице `channel_managers`
3. **Все еще админ в Telegram?** - Проверка через Telegram API

Если пользователь больше не является админом, операция будет отклонена.

## PR Manager Flow

### Автоматическое добавление менеджеров

При регистрации канала через `/register_channel`:
- Все администраторы канала автоматически сохраняются как менеджеры
- Сохраняются их права (can_post, can_edit, can_delete)
- Они могут управлять каналом в рамках своих прав

### Обновление списка менеджеров

Используйте `/verify_admins` для:
- Обновления списка после изменений в админах канала
- Проверки текущих прав каждого админа
- Синхронизации с Telegram

### Права менеджеров

Менеджеры могут:
- Просматривать каналы через `/mychannels`
- Управлять сделками (в рамках прав)
- Отправлять креативы (если имеют права)

**Ограничения:**
- Финансовые операции требуют проверки прав
- Изменение настроек канала - только для владельца

## Примеры использования

### Регистрация нового канала

```
1. Добавьте бота @your_bot как админа в канал
2. В канале отправьте: /register_channel
3. Бот ответит с подтверждением и ID канала
```

### Проверка админов

```
# Из канала
/verify_admins

# Или указав ID
/verify_admins -1001234567890
```

### Просмотр каналов

```
/mychannels
```

Покажет:
- Ваши каналы с статистикой
- Цены на рекламу
- Кнопки для управления

## Фильтры для поиска каналов

Через API можно использовать фильтры:

```bash
GET /api/channels?min_subscribers=10000&max_price=50&ad_format=post
```

**Доступные фильтры:**
- `min_subscribers` - Минимальное количество подписчиков
- `max_subscribers` - Максимальное количество подписчиков
- `min_price` - Минимальная цена в TON
- `max_price` - Максимальная цена в TON
- `ad_format` - Формат рекламы (post, forward, story)
- `language` - Язык канала

## Troubleshooting

### Бот не может зарегистрировать канал

**Проблема:** "Bot is not an administrator"

**Решение:**
1. Убедитесь, что бот добавлен как администратор
2. Проверьте, что бот имеет права на публикацию
3. Попробуйте удалить и добавить бота заново

### Канал уже зарегистрирован

**Проблема:** "Channel already registered"

**Решение:**
- Если вы владелец - используйте `/mychannels` для просмотра
- Если канал зарегистрирован другим пользователем - свяжитесь с поддержкой

### Не могу управлять каналом

**Проблема:** "You do not have access"

**Решение:**
1. Используйте `/verify_admins` для обновления прав
2. Убедитесь, что вы все еще админ в Telegram
3. Проверьте, что канал активен в системе
